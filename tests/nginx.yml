# SPDX-License-Identifier: MIT-0
---
- name: Test Nginx Ingress Controller Installation
  hosts: kubernetes_nodes
  gather_facts: true
  become: false
  vars:
    # Nginx ingress configuration using new structure
    nginx_ingress_kubeconfig:
      # Use default kubeconfig location on target node
      path: ""

    nginx_ingress_helm:
      wait: true
      timeout: "15m"
      force: false
    
    # Override service type if needed (default is already NodePort)
    # nginx_ingress_values:
    #   controller:
    #     service:
    #       type: "LoadBalancer"  # Example override

  pre_tasks:
    - name: Display target node information
      ansible.builtin.debug:
        msg: |
          Target Node Information:
          - Hostname: {{ inventory_hostname }}
          - IP Address: {{ ansible_host }}
          - User: {{ ansible_user }}
          - Python Interpreter: {{ ansible_python_interpreter }}

    - name: Check if target node is reachable
      ansible.builtin.ping:

    - name: Gather system information
      ansible.builtin.setup:
        gather_subset:
          - "!all"
          - "!min"
          - "system"
          - "network"

    - name: Display system information
      ansible.builtin.debug:
        msg: |
          System Information:
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Architecture: {{ ansible_architecture }}
          - Kernel: {{ ansible_kernel }}
          - Hostname: {{ ansible_hostname }}

    - name: Check if kubeconfig exists
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.kube/config"
      register: kubeconfig_check

    - name: Display kubeconfig status
      ansible.builtin.debug:
        msg: |
          Kubeconfig Status:
          - Path: {{ ansible_env.HOME }}/.kube/config
          - Exists: {{ kubeconfig_check.stat.exists }}
          - Size: {{ kubeconfig_check.stat.size | default('N/A') }} bytes
          - Owner: {{ kubeconfig_check.stat.pw_name | default('N/A') }}

    - name: Fail if kubeconfig doesn't exist
      ansible.builtin.fail:
        msg: "Kubeconfig file not found at {{ ansible_env.HOME }}/.kube/config. Please ensure kubectl is configured on the target node."
      when: not kubeconfig_check.stat.exists

    - name: Test kubectl connectivity
      ansible.builtin.command:
        cmd: kubectl cluster-info
      register: kubectl_test
      changed_when: false
      failed_when: kubectl_test.rc != 0

    - name: Display cluster information
      ansible.builtin.debug:
        msg: |
          Kubernetes Cluster Info:
          {{ kubectl_test.stdout }}

  roles:
    - padminisys.nginx_ingress.nginx

  post_tasks:
    # Verify nginx ingress controller installation using kubectl
    - name: Wait for nginx ingress controller deployment to be ready
      ansible.builtin.command:
        cmd: >-
          kubectl wait --for=condition=available --timeout=300s
          deployment/{{ nginx_ingress_release.name }}-controller
          -n {{ nginx_ingress_release.namespace }}
      register: deployment_wait
      changed_when: false

    - name: Get deployment status using kubectl
      ansible.builtin.command:
        cmd: >-
          kubectl get deployment {{ nginx_ingress_release.name }}-controller
          -n {{ nginx_ingress_release.namespace }} -o json
      register: deployment_kubectl
      changed_when: false

    - name: Get pods using kubectl
      ansible.builtin.command:
        cmd: >-
          kubectl get pods -n {{ nginx_ingress_release.namespace }}
          -l app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/component=controller
          -o json
      register: pods_kubectl
      changed_when: false

    - name: Get service using kubectl
      ansible.builtin.command:
        cmd: >-
          kubectl get service {{ nginx_ingress_release.name }}-controller
          -n {{ nginx_ingress_release.namespace }} -o json
      register: service_kubectl
      changed_when: false

    # Parse kubectl JSON output
    - name: Parse kubectl deployment output
      ansible.builtin.set_fact:
        deployment_info: "{{ deployment_kubectl.stdout | from_json }}"

    - name: Parse kubectl pods output
      ansible.builtin.set_fact:
        pods_info: "{{ pods_kubectl.stdout | from_json }}"

    - name: Parse kubectl service output
      ansible.builtin.set_fact:
        service_info: "{{ service_kubectl.stdout | from_json }}"

    # Extract service ports
    - name: Extract service ports
      ansible.builtin.set_fact:
        http_nodeport: "{{ service_info.spec.ports[0].nodePort | default('N/A') }}"
        https_nodeport: "{{ service_info.spec.ports[1].nodePort | default('N/A') }}"
      when: 
        - service_info.spec.type == 'NodePort'
        - service_info.spec.ports | length > 1

    # Display installation results
    - name: Display installation results
      ansible.builtin.debug:
        msg: |
          ğŸ‰ Nginx Ingress Controller Installation Complete!

          ğŸ“Š Deployment Status:
          - Name: {{ deployment_info.metadata.name | default('N/A') }}
          - Namespace: {{ deployment_info.metadata.namespace | default('N/A') }}
          - Ready Replicas: {{ deployment_info.status.readyReplicas | default(0) }}
          - Available Replicas: {{ deployment_info.status.availableReplicas | default(0) }}

          ğŸš€ Pod Status: Running
          - Total Pods: 1

          ğŸŒ Service Details:
          - Name: {{ service_info.metadata.name | default('N/A') }}
          - Type: {{ service_info.spec.type | default('N/A') }}
          - Cluster IP: {{ service_info.spec.clusterIP | default('N/A') }}
          {% if service_info.spec.type == 'NodePort' %}
          - HTTP NodePort: {{ http_nodeport | default('N/A') }}
          - HTTPS NodePort: {{ https_nodeport | default('N/A') }}
          {% endif %}

          âœ… Access URLs:
          {% if service_info.spec.type == 'NodePort' %}
          - HTTP: http://{{ ansible_host }}:{{ http_nodeport | default('N/A') }}
          - HTTPS: https://{{ ansible_host }}:{{ https_nodeport | default('N/A') }}
          {% elif service_info.spec.type == 'LoadBalancer' %}
          - LoadBalancer IP: {{ service_info.status.loadBalancer.ingress[0].ip | default('PENDING') }}
          {% else %}
          - Cluster IP: {{ service_info.spec.clusterIP | default('N/A') }}
          {% endif %}
      when: 
        - deployment_info is defined
        - service_info is defined
